!-----------------------------------------------------------------------
module ehy_main
!-----------------------------------------------------------------------
  use c__eprm  , only: istep,lxa1,npa1
  use v__in    , only: v__in__ini,pi,delt
  use p__init  , only: init
  use p__initmg, only: delx
  use p__passv , only: passv
  use p__passx , only: passx
  implicit none
!-----------------------------------------------------------------------
  real(kind=8)    ::  bf(3,lxa1), ef(3,lxa1), pbr(lxa1)
  real(kind=8)    ::  xx(npa1),vp1(3,npa1),pm1(3,npa1),lor(npa1)
  real(kind=8)    ::  alt(lxa1),fce(lxa1),lat(lxa1),hh(lxa1)
  integer(kind=4) ::  pind(npa1)
!
  real(kind=8)    ::  vpara,vperp,vpp,pxx,palp,palt
  real(kind=8)    ::  factp,aa
  integer(kind=4) ::  ii,ip0,ifile,ic
!
  contains
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
  subroutine ehy
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
    ip0 = 1
!-----------------------------------------------------------------------
    call v__in__ini
!-----------------------------------------------------------------------
    call init( xx,vp1,pm1,lor,bf,ef,pbr,pind,alt,fce,lat,hh )
!-----------------------------------------------------------------------
    factp = 180.d0/pi
!-----------------------------------------------------------------------
    do ii = 1,istep
      call passv( xx,vp1,pm1,lor,bf,ef,pbr )
      call passx( xx,vp1,pind )
!-----------------------------------------------------------------------
      if(mod(ii,istep/4).eq.0) &
&       write(6,'(7HTime = ,I10,1H/,I10)') ii,istep
      if(mod(ii,1000).eq.1) then
        do ip0 = 1,npa1
          vpara = vp1(1,ip0)
          vperp = sqrt( vp1(2,ip0)**2 + vp1(3,ip0)**2 )
          vpp = sqrt( vpara**2 + vperp**2 )
          pxx = xx(ip0)
          palp = asin(vperp/vpp)*factp
          if(pind(ip0).ne.0) cycle
!
          aa = xx(ip0)/delx
          aa = dint(aa+0.5d0)
          ic = aa
          palt = alt(ic)
!
          ifile = 70 + ip0
          write(ifile,'(I10,6(1PD12.4))') &
&           ii,dble(ii)*delt,palt,vpara,vperp,vpp,palp
        end do
      end if
!-----------------------------------------------------------------------
    end do
!-----------------------------------------------------------------------
    return
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
  end subroutine ehy
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
end module ehy_main
